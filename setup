#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_info() { echo -e "${YELLOW}→${NC} $1"; }

# Usage
usage() {
    echo "Usage: ./setup [wsl|ubuntu|mac]"
    echo ""
    echo "Platforms:"
    echo "  wsl     - Windows Subsystem for Linux (Ubuntu)"
    echo "  ubuntu  - Native Ubuntu/Debian"
    echo "  mac     - macOS"
    exit 1
}

# Check if platform argument provided
if [ $# -eq 0 ]; then
    usage
fi

PLATFORM=$1

# Validate platform
if [[ ! "$PLATFORM" =~ ^(wsl|ubuntu|mac)$ ]]; then
    print_error "Invalid platform: $PLATFORM"
    usage
fi

print_info "Setting up dotfiles for: $PLATFORM"
echo ""

# Install dependencies based on platform
install_deps() {
    case $PLATFORM in
        wsl|ubuntu)
            print_info "Installing dependencies via apt..."
            sudo apt update
            sudo apt install -y stow neovim tmux zsh git curl libnotify-bin
            print_success "Dependencies installed"
            ;;
        mac)
            print_info "Checking for Homebrew..."
            if ! command -v brew &> /dev/null; then
                print_info "Installing Homebrew..."
                /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
                print_success "Homebrew installed"
            else
                print_success "Homebrew already installed"
            fi

            print_info "Installing dependencies via Homebrew..."
            brew install stow neovim tmux git
            print_success "Dependencies installed"
            ;;
    esac
}

# Install Nerd Fonts
install_fonts() {
    case $PLATFORM in
        wsl)
            print_info "WSL detected - Fonts must be installed on Windows"
            echo ""
            echo "  1. Download: https://github.com/ryanoasis/nerd-fonts/releases"
            echo "  2. Install DroidSansMono Nerd Font"
            echo "  3. Windows Terminal → Settings → Font face → 'DroidSansMono Nerd Font'"
            echo ""
            print_info "Press Enter when fonts are installed..."
            read
            ;;
        ubuntu)
            print_info "Installing Nerd Font..."
            mkdir -p ~/.local/share/fonts
            cd ~/.local/share/fonts

            if [ ! -f "DroidSansMNerdFont-Regular.otf" ]; then
                curl -fLo "DroidSansMNerdFont-Regular.otf" \
                    https://github.com/ryanoasis/nerd-fonts/raw/HEAD/patched-fonts/DroidSansMono/DroidSansMNerdFont-Regular.otf
                fc-cache -fv
                print_success "Nerd Font installed"
                print_info "Configure your terminal to use 'DroidSansM Nerd Font'"
            else
                print_success "Nerd Font already installed"
            fi
            ;;
        mac)
            print_info "Installing Nerd Font..."
            brew install --cask font-droid-sans-mono-nerd-font 2>/dev/null || print_success "Nerd Font already installed"
            print_success "Nerd Font installed"
            print_info "Configure your terminal to use 'DroidSansM Nerd Font'"
            ;;
    esac
}

# Stow dotfiles
stow_dotfiles() {
    print_info "Creating symlinks with stow..."

    # Get the directory where this script is located
    DOTFILES_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    cd "$DOTFILES_DIR"

    # Backup existing configs
    if [ -d ~/.config/nvim ] && [ ! -L ~/.config/nvim ]; then
        print_info "Backing up existing nvim config..."
        mv ~/.config/nvim ~/.config/nvim.backup.$(date +%Y%m%d_%H%M%S)
    fi

    if [ -f ~/.tmux.conf ] && [ ! -L ~/.tmux.conf ]; then
        print_info "Backing up existing tmux config..."
        mv ~/.tmux.conf ~/.tmux.conf.backup.$(date +%Y%m%d_%H%M%S)
    fi

    if [ -f ~/.zshrc ] && [ ! -L ~/.zshrc ]; then
        print_info "Backing up existing zshrc..."
        mv ~/.zshrc ~/.zshrc.backup.$(date +%Y%m%d_%H%M%S)
    fi

    if [ -d ~/.config/kitty ] && [ ! -L ~/.config/kitty ]; then
        print_info "Backing up existing kitty config..."
        mv ~/.config/kitty ~/.config/kitty.backup.$(date +%Y%m%d_%H%M%S)
    fi

    # Backup existing claude config
    if [ -d ~/.claude ] && [ ! -L ~/.claude ]; then
        print_info "Backing up existing claude config..."
        mv ~/.claude ~/.claude.backup.$(date +%Y%m%d_%H%M%S)
    fi

    # Stow configs
    stow -R nvim tmux zsh claude kitty
    print_success "Symlinks created"
}

# Setup Claude Code plugins (delegated to separate script)
setup_claude() {
    "$DOTFILES_DIR/setup-claude-plugins"
}

# Change default shell to zsh
setup_zsh() {
    if [ "$SHELL" != "$(which zsh)" ]; then
        print_info "Changing default shell to zsh..."
        chsh -s $(which zsh)
        print_success "Default shell changed to zsh (restart terminal to apply)"
    else
        print_success "zsh is already the default shell"
    fi
}

# Main setup
main() {
    install_deps
    echo ""
    install_fonts
    echo ""
    stow_dotfiles
    echo ""
    setup_claude
    echo ""
    setup_zsh
    echo ""
    print_success "Setup complete!"
    echo ""
    print_info "Next steps:"
    echo "  1. Restart your terminal"
    echo "  2. Open Neovim and run: :Lazy sync"
    echo "  3. Run: :checkhealth"
    echo "  4. If Claude Code was not installed, run: ./setup-claude-plugins"
    echo ""
}

main
